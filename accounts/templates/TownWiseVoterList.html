<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Techno चुनाव-Town Wise Voters List</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />

  <style>
    /* scrollbar */
    body::-webkit-scrollbar {
      width: 10px;
    }

    body::-webkit-scrollbar-thumb:hover {
      background: #838ab6;
    }

    body::-webkit-scrollbar {
      background-color: transparent;
    }

    body::-webkit-scrollbar-thumb {
      background: #9DA5D5;
      border-radius: 8px;
    }

    table th {
      font-weight: 600;
      background-color: #DCE1FF !important;
    }

    .pagination .page-item.active .page-link {
      color: #fff;
      background-color: #3C4CAC;
      border-color: #DCE1FF;
    }

    .search {
      position: relative;
    }

    .btn-close {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }

    .input-group {
      position: relative;
    }

    .custom-text-light {
      color: gray;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    .page-label {
      margin: 0 10px;
      font-size: 16px;
      font-weight: bold;
    }

    button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  {% include "navbar.html" %}
  <div id="contentWrapper">
    <div style="flex: 1">
      <div class="container mt-3">

        <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item custom-text-light"><a class="nav-link" href="/dashboard/">Dashboard</a></li>
            <li class="breadcrumb-item custom-text-light" aria-current="page" style="cursor: default;">Voter</li>
            <li class="breadcrumb-item" aria-current="page" style="cursor: default;">Town Wise Voters List</li>
          </ol>
        </nav>

        <div class="row">
          <div class="col-12">
            <div class="overflow-hidden card bg-light rounded table-card mb-3">
              <div class="row">
                <div class="col mx-5">
                  <br><br>
                  <div class="mb-4">
                    <select id="townSelect" class="form-select" aria-label="Select Town">
                      <option value="" disabled selected>Select Town</option>
                    </select>
                  </div>
                  <div class="row justify-content-center text-center">
                    <div class="col-4">
                      <h6 class="mt-1" style="cursor: default;"><strong>Total Voters:</strong>
                        <span id="voterCount">0</span>
                      </h6>
                    </div>
                    <div class="col-4">
                      <h6 class="mt-1" style="cursor: default;"><strong>Voted Voters:</strong>
                        <span id="votedCount">0</span>
                      </h6>
                      <p id="votedCountParcent"><i>percent: 0%</i></p>
                    </div>
                    <div class="col-4">
                      <h6 class="mt-1" style="cursor: default;"><strong>Non-voted Voters:</strong>
                        <span id="non-votedCount">0</span>
                      </h6>
                      <p id="non-votedCountParcent"><i>percent: 0%</i></p>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- <div class="d-flex justify-content-end gap-3 me-4 mb-1">
          <div class="mb-3">
            <div class="input-group mb-3" style="width: 230px;">
              <select id="caste-select" class="form-select bg-light" aria-label="Small select example">
                <option selected>Select Caste</option>
              </select>
              <button id="update-button" class="btn btn-primary input-group-append">Assign</button>
            </div>
          </div>
          <div class=" mb-3">
            <div class="input-group" style="width: 320px;">
              <select id="locationtypeSelect" class="form-select bg-light" aria-label="Small select example">
                <option selected value="null">Select Location</option>
                <option value="1">In City</option>
                <option value="2">Near City</option>
                <option value="3">Out of City</option>
              </select>
              <select id="town-type-select" class="form-select bg-light" aria-label="Small select example">
                <option selected>Select Favour</option>
                <option class="text-success" value="1">Green</option>
                <option class="text-danger" value="2">Red</option>
                <option class="text-warning" value="3">Yellow</option>
                <option class="text-primary" value="4">Blue</option>
                <option style="color: rgb(17, 180, 255);" value="5">Light Blue</option>
                <option style="color: palevioletred;" value="6">Pink</option>
                <option style="color: purple;" value="7">Purple</option>
              </select>
            </div>
          </div>

          <div class="search" style="width: 260px;">
            <div class="input-group">
              <input type="text" id="search-input" name="search" class="form-control bg-light"
                placeholder="Search by Name" />
              <button type="button" id="clear-button" class="btn-close" aria-label="Close"></button>
              <button class="btn btn-success" type="button" id="search-button">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </div>
          </div>

          <a href="#" class="btn btn-light border me-4 mb-3" id="exportButton">
            <i class="fa-solid fa-arrow-up-from-bracket"></i>&nbsp;Export
          </a>
        </div> -->
        <div class="d-flex justify-content-end gap-3 me-4 mb-1">
          <!-- Voter caste assign -->
          <div class="mb-3" style="display: none;" id="caste-select-container">
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="input-group mb-3" style="width: 100%;">
                  <select id="caste-select" class="d-flex form-select bg-light" aria-label="Small select example">
                    <option selected>Select Caste</option>
                  </select>
                  <button id="update-button" class="btn btn-primary input-group-append">Assign</button>
                </div>
              </div>

              <div class="col-md-6 mb-3" id="favour-select-container">
                <div class="input-group mb-3" style="width: 100%;">
                  <select id="favour-type-select" class="form-select bg-light" aria-label="Small select example">
                    <option selected>Select Favour </option>
                    <option class="text-success" value="1">Green</option>
                    <option class="text-danger" value="2">Red</option>
                    <option class="text-warning" value="3">Yellow</option>
                    <option class="text-primary" value="4">Blue</option>
                    <option style="color: rgb(17, 180, 255);" value="5">Light Blue</option>
                    <option style="color: palevioletred;" value="6">Pink</option>
                    <option style="color: purple;" value="7">Purple</option>
                  </select>
                  <button id="fav-update-button" class="btn btn-primary input-group-append">Assign</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Voter location & favour filter -->
          <div class="mb-3" id="location-favor-filters">
            <div class="input-group" style="width: 320px;">
              <select id="locationtypeSelect" class="form-select bg-light" aria-label="Small select example">
                <option selected value="null">Select Location</option>
                <option value="1">In City</option>
                <option value="2">Near City</option>
                <option value="3">Out of City</option>
              </select>
              <select id="town-type-select" class="form-select bg-light" aria-label="Small select example">
                <option selected>Select Favour</option>
                <option class="text-success" value="1">Green</option>
                <option class="text-danger" value="2">Red</option>
                <option class="text-warning" value="3">Yellow</option>
                <option class="text-primary" value="4">Blue</option>
                <option style="color: rgb(17, 180, 255);" value="5">Light Blue</option>
                <option style="color: palevioletred;" value="6">Pink</option>
                <option style="color: purple;" value="7">Purple</option>
              </select>
            </div>
          </div>

          <div class="search" style="width: 250px;">
            <div class="input-group">
              <input type="text" id="search-input" name="search" class="form-control bg-light"
                placeholder="Search by Name or Card No" />
              <button type="button" id="clear-button" class="btn-close" aria-label="Close"></button>
              <!-- <button class="btn btn-success" type="button" id="search-button">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button> -->
            </div>
          </div>

          <a href="#" class="btn btn-light border me-4 mb-3" id="exportButton">
            <i class="fa-solid fa-arrow-up-from-bracket"></i>&nbsp;Export
          </a>
        </div>


        <!-- Search -->
        <!-- <div class="d-flex justify-content-end me-4 mb-3">
          <div class="search" style="width: 350px;">
            <div class="input-group">
              <input type="text" id="search-input" name="search" class="form-control bg-light"
                placeholder="Search by Name" />
              <button type="button" id="clear-button" class="btn-close" aria-label="Close"></button>
              <button class="btn btn-success" type="button" id="search-button">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </div>
          </div>
        </div> -->

        <!-- Table -->
        <div class="col-12 mb-3 mb-lg-5">
          <div class="overflow-hidden table-nowrap rounded table-card">
            <div class="table-responsive">
              <table class="table mb-0 table-striped">
                <thead class="text-muted text-uppercase" style="display: none;" id="tableHeading">
                  <tr>
                    <th><input class="form-check-input" type="checkbox" value="" id="select-all-checkbox"></th>
                    <th class="fw-bolder" style="width: 10%;">Sr. No.</th>
                    <th class="fw-bolder" style="width: 10%;">Reg. No.</th>
                    <th class="fw-bolder" style="width: 15%;">CARD No.</th>
                    <th class="fw-bolder" style="width: 20%;">Voter Name</th>
                    <th class="fw-bolder" style="width: 15%;">Contact Number</th>
                    <th class="bg-blue fw-bolder" style="width: 20%;">Current Location</th>
                    <th class="fw-bolder" style="width: 15%;">Actions</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="votersTableBody">
                </tbody>
              </table>
            </div>
            <div id="paginationControls" class="pagination"></div>
          </div>
        </div>

        <div class="modal fade" id="voterDetailsModal" tabindex="-1" aria-labelledby="voterDetailsModalLabel"
          aria-hidden="true">
          <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
              <div class="modal-header thd">
                <h5 class="modal-title" id="voterDetailsModalLabel">Voter Details</h5>
                <div class="ms-auto">
                  <a type="button" id="edit-button" class="btn btn-outline-danger me-2">
                    <i class="fa-solid fa-user-pen"></i>&nbsp;Edit
                  </a>
                  <a type="button" id="family-button" class="btn btn-outline-primary">
                    <i class="fa-solid fa-users"></i>&nbsp;Family</a>
                </div>
              </div>
              <div class="modal-body">
                <table class="table p-1">
                  <tbody>
                    <tr>
                      <th class="bg-light fw-semibold">Registration No.</th>
                      <td id="voter_serial_number"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Voter Card No.</th>
                      <td id="voter_id_card_number"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Voter Name</th>
                      <td id="voter_name"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Parent Name</th>
                      <td id="voter_parent_name"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Date of Birth</th>
                      <td id="voter_dob"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Live Status</th>
                      <td id="voter_live_status"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Gender</th>
                      <td id="voter_gender"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Contact Number</th>
                      <td id="voter_contact_number"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Age</th>
                      <td id="voter_age"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Marital Status</th>
                      <td id="marital_status"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Cast</th>
                      <td id="voter_cast_name"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Location Type</th>
                      <td id="voter_in_city"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Current Location</th>
                      <td id="current_location"></td>
                    </tr>

                    <tr>
                      <th class="bg-light fw-semibold">Town Name</th>
                      <td id="town_name"></td>
                    </tr>
                    <tr>
                      <th class="bg-light fw-semibold">Booth Name</th>
                      <td id="booth_name"></td>
                    </tr>
                  </tbody>
                </table>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-light m-1" id="export-pdf-button">
                    <i class="fa-solid fa-arrow-up-from-bracket"></i>&nbsp;Export
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Toast Messages -->
        <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
          {% if messages %}
          {% for message in messages %}
          <div
            class="toast align-items-center text-bg-{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}danger{% else %}info{% endif %} border-0"
            role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
            <div class="d-flex">
              <div class="toast-body">
                {{ message }}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
            </div>
          </div>
          {% endfor %}
          {% endif %}
        </div>

        <!-- Pagination controls -->
        <div class="d-flex justify-content-center">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mx-4" id="paginationControls">
              <!-- Pagination buttons will be dynamically inserted here -->
            </ul>
          </nav>
        </div>

      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let currentVoterId = null;  // Variable to store the currently selected voter ID
      let votersData = [];         // Array to hold fetched voter data

      // Show loading animation until data is fetched
      function onDropdownChange(event) {
        const dropdown = event.target;
        const selectedValue = townSelect.value;

        // Only proceed if the selected value is not the default one
        if (selectedValue !== "0") {
          document.getElementById('loading').style.display = 'block';
          document.getElementById('result').textContent = ''; // Clear previous result

          fetchData(selectedValue).then((data) => {
            // Hide loading animation once data is fetched
            document.getElementById('loading').style.display = 'none';

            // Show the fetched data
            document.getElementById('result').textContent = data;
          });
        }
      }

      // Function to fetch towns and set up the select dropdown
      function fetchTowns() {
        fetch('http://192.168.200.151:8001/api/towns/')
          .then(response => response.json())
          .then(data => {
            const townSelect = document.getElementById('townSelect');
            data.forEach(town => {
              const option = document.createElement('option');
              option.value = town.town_id;
              option.textContent = town.town_name;
              townSelect.appendChild(option);
            });

            // Add event listener for town selection
            townSelect.addEventListener('change', function () {
              const selectedTownId = townSelect.value;
              if (selectedTownId) {
                fetchVoters(selectedTownId); // Fetch voters based on selected town
              }
            });
          })
          .catch(error => console.error('Error fetching towns data:', error));
      }

      // Function to fetch voters based on town_id
      async function fetchVoters(townId) {
        try {
          const response = await fetch(`http://192.168.200.151:8001/api/town_wise_voter_list/${townId}/`);
          const data = await response.json();
          votersData = data;  // Store the fetched voters data
          // console.log(votersData);

          renderVoters(votersData);  // Render voters in the table
        } catch (error) {
          console.error('Error fetching voters data:', error);
        }
      }

      const votersPerPage = 1000;
      let currentPage = 1;
      // Function to render voters in the table
      function renderVoters(voters) {
        const tableBody = document.getElementById('votersTableBody');
        tableBody.innerHTML = ''; // Clear previous voters

        // Hide the table headings if there are no voters
        if (voters.length === 0) {
          tableHeading.style.display = 'none'; // Hide the heading
          // updateCounts(0, 0, 0); // Reset counts when no data is available
          return;
        } else {
          // Show the table heading if there are voters
          tableHeading.style.display = 'table-header-group'; // Ensure the heading is visible
        }

        const totalVoters = voters.length;  // Total number of voters
        const votedVoters = voters.filter(voter => voter.voter_vote_confirmation_id !== null).length; // Count of voted voters
        const nonVotedVoters = totalVoters - votedVoters; // Count of non-voted voters
        const votedVotersParc = ((votedVoters / totalVoters) * 100).toFixed(2);
        const nonVotedVotersParc = ((nonVotedVoters / totalVoters) * 100).toFixed(2);

        // Update counts in the respective elements
        document.getElementById('voterCount').textContent = totalVoters;
        document.getElementById('votedCount').textContent = votedVoters;
        document.getElementById('non-votedCount').textContent = nonVotedVoters;
        document.getElementById('votedCountParcent').textContent = votedVotersParc;
        document.getElementById('non-votedCountParcent').textContent = nonVotedVotersParc;

        document.getElementById('votedCountParcent').innerHTML = "percent: <i>" + votedVotersParc + "%</i>";
        document.getElementById('votedCountParcent').style.fontStyle = "italic"; // Optional for the overall style

        document.getElementById('non-votedCountParcent').innerHTML = "percent: <i>" + nonVotedVotersParc + "%</i>";
        document.getElementById('non-votedCountParcent').style.fontStyle = "italic"; // Optional for the overall style

        // // Sort voters alphabetically by voter_name
        // voters.sort((a, b) => a.voter_name.localeCompare(b.voter_name));
        // Sort voters alphabetically by voter_name, handle null/undefined voter_name
        voters.sort((a, b) => {
          const nameA = a.voter_name || '';  // Default to empty string if null or undefined
          const nameB = b.voter_name || '';  // Default to empty string if null or undefined
          return nameA.localeCompare(nameB);
        });

        // // Populate the table with voters
        // voters.forEach((voter, index) => {
        //   const row = document.createElement('tr');

        // Calculate the total number of pages
        totalPages = Math.ceil(totalVoters / votersPerPage);  // Correctly calculate total pages
        // console.log('tp--', totalPages);


        // Slice the voters array for the current page

        const startIndex = (currentPage - 1) * votersPerPage;
        const endIndex = startIndex + votersPerPage;
        // console.log('si-', startIndex, 'ei-', endIndex);

        const paginatedVoters = voters.slice(startIndex, endIndex);
        // console.log('pv--', paginatedVoters);


        // Populate the table with voters for the current page
        paginatedVoters.forEach((voter, index) => {
          const row = document.createElement('tr');

          // Checkbox cell
          const checkboxCell = document.createElement('td');
          checkboxCell.style.textAlign = 'center';
          const checkbox = document.createElement('input');
          checkbox.classList.add('form-check-input'); // Add Bootstrap class for the checkbox
          checkbox.type = 'checkbox'; // Set the checkbox type
          checkbox.id = `voterCheck_${voter.voter_id}`; // Set the checkbox ID to the voter ID
          checkbox.value = voter.voter_id;
          checkboxCell.appendChild(checkbox);
          row.appendChild(checkboxCell);

          const serialNumber = startIndex + index;

          const srNoCell = document.createElement('td');
          // srNoCell.style.textAlign = 'center';
          srNoCell.textContent = serialNumber + 1;
          row.appendChild(srNoCell);


          const VsrNOCell = document.createElement('td');
          VsrNOCell.style.textAlign = 'start';
          VsrNOCell.textContent = voter.voter_serial_number || 'None';
          row.appendChild(VsrNOCell);

          const VidNOCell = document.createElement('td');
          VidNOCell.style.textAlign = 'start';
          VidNOCell.textContent = voter.voter_id_card_number || 'None';
          row.appendChild(VidNOCell);

          const nameCell = document.createElement('td');
          nameCell.textContent = capitalizeWords(voter.voter_name || 'None');
          row.appendChild(nameCell);

          const contactCell = document.createElement('td');
          contactCell.style.textAlign = 'start';
          contactCell.textContent = voter.voter_contact_number || 'None';
          row.appendChild(contactCell);

          const locationCell = document.createElement('td');
          locationCell.style.textAlign = 'start';
          locationCell.textContent = voter.voter_current_location || 'None';
          row.appendChild(locationCell);

          // Actions Cell
          const actionsCell = document.createElement('td');
          let detailsButton;
          detailsButton = document.createElement('button');
          detailsButton.className = 'btn voter-detail-link btn-light btn-sm m-1';
          detailsButton.innerHTML = '<i class="fa-solid fa-circle-info"></i>';

          // Create a toggle button for vote confirmation
          const voteConfirmationButton = document.createElement('button');

          // Set the button icon based on the current confirmation status
          if (voter.voter_vote_confirmation_id === null) {
            voteConfirmationButton.className = 'btn btn-secondary btn-sm m-1';
            voteConfirmationButton.innerHTML = '<i class="fa-regular fa-thumbs-up"></i>'; // Icon for "Confirm Vote"
          } else {
            voteConfirmationButton.className = 'btn btn-primary btn-sm m-1';
            voteConfirmationButton.innerHTML = '<i class="fa-solid fa-thumbs-up"></i>'; // Icon for "Undo Confirmation"
          }

          // Add event listener for toggling vote confirmation
          voteConfirmationButton.addEventListener('click', async () => {
            const newConfirmationStatus = voter.voter_vote_confirmation_id === null ? 1 : null; // Toggle logic

            try {
              const response = await fetch(`http://192.168.200.151:8001/api/voter_confirmation/${voter.voter_id}/`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ voter_vote_confirmation_id: newConfirmationStatus })
              });

              if (!response.ok) {
                throw new Error('Failed to update vote confirmation status');
              }
              // else {
              //   alert('Vote confirmation status updated successfully');
              // }

              // Update the button icon and voter object
              voter.voter_vote_confirmation_id = newConfirmationStatus; // Update the current status
              
              if (newConfirmationStatus === null) {
                voteConfirmationButton.className = 'btn btn-secondary btn-sm m-1';
                voteConfirmationButton.innerHTML = '<i class="fa-regular fa-thumbs-up"></i>'; // Icon for "Confirm Vote"
              } else {
                voteConfirmationButton.className = 'btn btn-primary btn-sm m-1';
                voteConfirmationButton.innerHTML = '<i class="fa-solid fa-thumbs-up"></i>'; // Icon for "Undo Confirmation"
              }

            } catch (error) {
              console.error('Error toggling vote confirmation:', error);
              alert('Error toggling vote confirmation. Please try again.');
            }
          });
          actionsCell.appendChild(voteConfirmationButton);

          detailsButton.onclick = function () {
            currentVoterId = voter.voter_id;
            // Fetch voter details from the API
            fetch(`http://192.168.200.151:8001/api/voters/${voter.voter_id}/`)
              .then(response => {
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                return response.json();
              })
              .then(voterDetails => {
                // Populate the modal with voter details
                document.getElementById('voter_serial_number').textContent = voterDetails.voter_serial_number || '--';
                document.getElementById('voter_id_card_number').textContent = voterDetails.voter_id_card_number || '--';
                document.getElementById('voter_name').textContent = capitalizeWords(voterDetails.voter_name) || '--';
                document.getElementById('voter_parent_name').textContent = capitalizeWords(voterDetails.voter_parent_name) || '--';
                document.getElementById('voter_dob').textContent = voterDetails.voter_dob || '--';
                document.getElementById('voter_gender').textContent = voterDetails.voter_gender || '--';
                document.getElementById('voter_contact_number').textContent = voterDetails.voter_contact_number || '--';
                document.getElementById('voter_age').textContent = voterDetails.voter_age || '--';
                document.getElementById('voter_cast_name').textContent = voterDetails.voter_cast_name || '--';
                document.getElementById('town_name').textContent = voterDetails.town_name || '--';
                document.getElementById('booth_name').textContent = voterDetails.booth_name || '--';

                document.getElementById('voter_in_city').textContent = (voterDetails.voter_in_city_id === 1) ? 'In City' : (voterDetails.voter_in_city_id === 2 ? 'Near City' : (voterDetails.voter_in_city_id === 3 ? 'Out of City' : '--'));
                document.getElementById('voter_live_status').textContent = (voterDetails.voter_live_status_id === 1) ? 'Alive' : (voterDetails.voter_live_status_id === 2 ? 'Dead' : '--');
                document.getElementById('marital_status').textContent = voterDetails.marital_status_type || '--';
                document.getElementById('current_location').textContent = voterDetails.voter_current_location || '--';

                // Update the Family button with the voter ID
                document.getElementById('family-button').href = `/familydetails/${voter.voter_id}/`;

                // Update the Edit button with the voter ID
                document.getElementById('edit-button').href = `/editvoter/${voter.voter_id}/`;

                // Change the background color of elements with class 'thd' based on voter_favour_id
                const thdElements = document.querySelectorAll('.thd');
                thdElements.forEach(element => {
                  element.style.backgroundColor = ''; // Clear previous colors
                });

                // Set Voter Details background color based on favour_id
                switch (parseInt(voterDetails.voter_favour_id)) {
                  case 1:
                    thdElements.forEach(element => {
                      element.style.backgroundColor = '#D1E7DD'; // Light Green
                    });
                    break;
                  case 2:
                    thdElements.forEach(element => {
                      element.style.backgroundColor = '#F8D7DA'; // Light Red
                    });
                    break;
                  case 3:
                    thdElements.forEach(element => {
                      element.style.backgroundColor = '#fff3cd'; // Light Yellow
                    });
                    break;
                  case 4:
                    thdElements.forEach(element => {
                      element.style.backgroundColor = '#DCE1FF'; // Light Blue
                    });
                    break;
                  case 5:
                    thdElements.forEach(element => {
                      element.style.backgroundColor = '#d1faff'; // Light Sky blue
                    });
                    break;
                  case 6:
                    thdElements.forEach(element => {
                      element.style.backgroundColor = '#fed6ff'; // Light Pink
                    });
                    break;
                  case 7:
                    thdElements.forEach(element => {
                      element.style.backgroundColor = '#ebd1ff'; // Light Purple
                    });
                    break;
                  default:
                    thdElements.forEach(element => {
                      element.style.backgroundColor = '#D3D3D3'; // Default Grey
                    });
                }
                // Show the modal
                const voterDetailsModal = new bootstrap.Modal(document.getElementById('voterDetailsModal'));
                voterDetailsModal.show();
              })
          };

          actionsCell.appendChild(detailsButton);
          row.appendChild(actionsCell);

          // New column for voter_favour_id (optional display)
          const favourCell = document.createElement('td');
          switch (voter.voter_favour_id) {
            case 1:
              favourCell.style.backgroundColor = 'Green'; // Green
              break;
            case 2:
              favourCell.style.backgroundColor = 'Red'; // red
              break;
            case 3:
              favourCell.style.backgroundColor = 'Yellow'; // yellow
              break;
            case 4:
              favourCell.style.backgroundColor = '#0B5ED7';  // blue
              break;
            case 5:
              favourCell.style.backgroundColor = 'rgb(17, 180, 255)';  // Sky Blue
              break;
            case 6:
              favourCell.style.backgroundColor = 'palevioletred';  // Pink
              break;
            case 7:
              favourCell.style.backgroundColor = 'purple';  // Purple
              break;
            default:
              favourCell.style.backgroundColor = '#D3D3D3';  // default grey
          }
          row.appendChild(favourCell);
          tableBody.appendChild(row);
        });
        // Update pagination controls
        updatePaginationControls(currentPage, totalPages);
      }
      // // Function to update pagination controls (Only Prev and Next)
      // function updatePaginationControls(page, totalPages) {
      //   const paginationContainer = document.getElementById('paginationControls');
      //   paginationContainer.innerHTML = ''; // Clear previous pagination controls

      //   // Previous button
      //   const prevButton = document.createElement('button');
      //   prevButton.textContent = 'Previous';
      //   prevButton.classList.add('btn', 'btn-light');
      //   prevButton.disabled = currentPage === 1; // Disable if on the first page
      //   prevButton.onclick = () => {
      //     if (currentPage > 1) {
      //       currentPage--;
      //       renderVoters(votersData); // Re-render with new page data
      //     }
      //   };
      //   paginationContainer.appendChild(prevButton);

      //   // Current page label
      //   const currentPageLabel = document.createElement('span');
      //   currentPageLabel.classList.add('page-label');
      //   currentPageLabel.textContent = `Page ${currentPage}`;
      //   paginationContainer.appendChild(currentPageLabel);

      //   // Next button
      //   const nextButton = document.createElement('button');
      //   nextButton.textContent = 'Next';
      //   nextButton.classList.add('btn', 'btn-light');
      //   nextButton.disabled = currentPage === totalPages; // Disable if on the last page

      //   nextButton.onclick = () => {
      //     if (currentPage < totalPages) {
      //       currentPage++;
      //       renderVoters(votersData); // Re-render with new page data
      //     }
      //   };
      //   paginationContainer.appendChild(nextButton);
      // }

      function updatePaginationControls(page, totalPages) {
        const paginationContainer = document.getElementById('paginationControls');
        paginationContainer.innerHTML = ''; // Clear previous pagination controls

        // First page button
        const firstButton = document.createElement('li');
        firstButton.classList.add('page-item');
        const firstLink = document.createElement('a');
        firstLink.classList.add('page-link');
        firstLink.href = `#`;
        firstLink.setAttribute('aria-label', 'First');
        firstLink.innerHTML = '&laquo;&laquo;';
        firstButton.appendChild(firstLink);
        if (currentPage === 1) firstButton.classList.add('disabled');
        firstButton.onclick = () => {
          currentPage = 1;
          renderVoters(votersData);
        };
        paginationContainer.appendChild(firstButton);

        // Previous page button
        const prevButton = document.createElement('li');
        prevButton.classList.add('page-item');
        const prevLink = document.createElement('a');
        prevLink.classList.add('page-link');
        prevLink.href = `#`;
        prevLink.setAttribute('aria-label', 'Previous');
        prevLink.innerHTML = '&laquo;';
        prevButton.appendChild(prevLink);
        if (currentPage === 1) prevButton.classList.add('disabled');
        prevButton.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderVoters(votersData);
          }
        };
        paginationContainer.appendChild(prevButton);

        // Page numbers (show a range around the current page)
        for (let num = Math.max(1, currentPage - 1); num <= Math.min(totalPages, currentPage + 1); num++) {
          const pageItem = document.createElement('li');
          pageItem.classList.add('page-item');
          if (num === currentPage) {
            pageItem.classList.add('active');
          }
          const pageLink = document.createElement('a');
          pageLink.classList.add('page-link');
          pageLink.href = `#`;
          pageLink.innerText = num;
          pageLink.onclick = () => {
            currentPage = num;
            renderVoters(votersData);
          };
          pageItem.appendChild(pageLink);
          paginationContainer.appendChild(pageItem);
        }

        // Next page button
        const nextButton = document.createElement('li');
        nextButton.classList.add('page-item');
        const nextLink = document.createElement('a');
        nextLink.classList.add('page-link');
        nextLink.href = `#`;
        nextLink.setAttribute('aria-label', 'Next');
        nextLink.innerHTML = '&raquo;';
        nextButton.appendChild(nextLink);
        if (currentPage === totalPages) nextButton.classList.add('disabled');
        nextButton.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderVoters(votersData);
          }
        };
        paginationContainer.appendChild(nextButton);

        // Last page button
        const lastButton = document.createElement('li');
        lastButton.classList.add('page-item');
        const lastLink = document.createElement('a');
        lastLink.classList.add('page-link');
        lastLink.href = `#`;
        lastLink.setAttribute('aria-label', 'Last');
        lastLink.innerHTML = '&raquo;&raquo;';
        lastButton.appendChild(lastLink);
        if (currentPage === totalPages) lastButton.classList.add('disabled');
        lastButton.onclick = () => {
          currentPage = totalPages;
          renderVoters(votersData);
        };
        paginationContainer.appendChild(lastButton);
      }

      // Add event listener for the export button in Voter Details
      document.getElementById('export-pdf-button').addEventListener('click', function () {
        if (currentVoterId) {
          const pdfUrl = `http://192.168.200.151:8001/api/generate_voter_pdf/${currentVoterId}/`;
          fetch(pdfUrl)
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.blob(); // Get the response as a Blob
            })
            .then(blob => {
              const url = window.URL.createObjectURL(blob); // Create a URL for the Blob
              const a = document.createElement('a'); // Create a link element
              a.href = url;
              a.download = `voterDetails.pdf`; // Set the desired file name
              document.body.appendChild(a); // Append the link to the body
              a.click(); // Programmatically click the link to trigger the download
              a.remove(); // Remove the link from the document
              window.URL.revokeObjectURL(url); // Revoke the Object URL
            })
            .catch(error => console.error('Error generating PDF:', error));
        } else {
          console.warn('No voter ID available for export.');
        }
      });

      // Export button functionality in Page
      exportButton.addEventListener('click', function (event) {
        event.preventDefault(); // Prevent default anchor behavior

        const selectedTownId = townSelect.value;
        const selectedLocationId = locationtypeSelect.value;


        if (!selectedTownId || !selectedLocationId) {
          alert('Please select both Town and Location before exporting pdf.');
          return;
        }

        const pdfUrl = `http://192.168.200.151:8001/api/generate_voter_pdf_by_town/town_id/${selectedTownId}/city_id/${selectedLocationId}/`;

        if (selectedTownId || selectedLocationId) {
          // Fetch PDF
          fetch(pdfUrl)
            .then(response => {
              if (!response.ok) {
                throw new Error('Network response was not ok');
              }
              return response.blob();
            })
            .then(blob => {
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `TownWiseVoterList.pdf`;
              document.body.appendChild(a);
              a.click();
              a.remove();
            })
            .catch(error => {
              alert('Make sure you have selected both Town and Location before exporting pdf.');
            });
        } else {
          alert('Please select both Town and Location before exporting pdf.');
        }
      });

      // Favor type filter
      document.getElementById('town-type-select').addEventListener('change', function () {
        const selectedFavourId = parseInt(this.value);
        if (!isNaN(selectedFavourId)) {
          const filteredVoters = votersData.filter(voter => voter.voter_favour_id === selectedFavourId);
          renderVoters(filteredVoters);
        } else {
          renderVoters(votersData); // If no selection, show all voters
        }
      });

      // Location type filter
      document.getElementById('locationtypeSelect').addEventListener('change', function () {
        const selectedLocationId = parseInt(this.value);
        if (!isNaN(selectedLocationId)) {
          const filteredVoters = votersData.filter(voter => voter.voter_in_city_id === selectedLocationId);
          renderVoters(filteredVoters);
        } else {
          renderVoters(votersData); // If no selection, show all voters
        }
      });

      // Function to capitalize the first letter of each word
      function capitalizeWords(str) {
        if (typeof str !== 'string' || !str) {
          return ''; // Return an empty string if the input is not a valid string
        }
        return str.split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
      }


      // Function to get URL parameters
      function getTownIdFromPath() {
        const pathParts = window.location.pathname.split('/'); // Split the path by '/'
        const townId = pathParts[pathParts.length - 2]; // Get the second to last element (the town_id)
        return townId;
      }


      // Main function to initialize the page
      function init() {
        fetchTowns();  // Fetch towns data on page load

        // Get town_id from the URL path
        const townIdFromPath = getTownIdFromPath();
        // console.log('town_id from path:', townIdFromPath); // Log the retrieved town_id

        if (townIdFromPath) {
          const townId = parseInt(townIdFromPath, 10);
          // console.log('Parsed townId:', townId); // Log the parsed integer
          fetchVoters(townId); // Fetch voters for the town_id from URL
        } else {
          // console.log('No town_id found in URL path'); // Log if no town_id is found
        }
      }
      init();  // Initialize the page

      // Search functionality
      document.getElementById('search-input').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const filteredVoters = votersData.filter(voter =>
          voter.voter_name?.toLowerCase().includes(searchTerm) ||
          voter.voter_id_card_number?.toLowerCase().includes(searchTerm)
        );
        renderVoters(filteredVoters);
      });


      // Clear search input
      document.getElementById('clear-button').addEventListener('click', () => {
        document.getElementById('search-input').value = '';
        renderVoters(votersData); // Render original voters data
      });
    });




    document.addEventListener('DOMContentLoaded', function () {
      // Fetch caste data from the API and populate the caste select options
      fetch('http://192.168.200.151:8001/api/cast/')
        .then(response => response.json())
        .then(data => {
          const casteSelect = document.getElementById('caste-select');

          // Add each caste option to the select dropdown
          data.forEach(caste => {
            const option = document.createElement('option');
            option.value = caste.cast_id;
            option.textContent = caste.cast_name;
            casteSelect.appendChild(option);
          });
        })
        .catch(error => console.error('Error fetching caste data:', error));

      // Add event listener to handle voter row selection
      let selectedVoters = [];
      const tableBody = document.getElementById('votersTableBody');

      tableBody.addEventListener('click', function (event) {
        // Check if the clicked element is a checkbox
        if (event.target.type === 'checkbox') {
          const checkbox = event.target;
          const row = checkbox.closest('tr'); // Get the row that contains the checkbox
          const voterId = checkbox.value; // Get voter ID from the checkbox value

          // Toggle the "selected" class to indicate voter selection
          row.classList.toggle('selected', checkbox.checked);

          // Add or remove the voter from the selectedVoters array
          if (checkbox.checked) {
            // Add voter ID to selectedVoters if checkbox is checked
            selectedVoters.push(voterId);
          } else {
            // Remove voter ID from selectedVoters if checkbox is unchecked
            selectedVoters = selectedVoters.filter(id => id !== voterId);
          }

          // Show or hide caste select based on the number of selected voters
          if (selectedVoters.length > 0) {
            // Show caste select and hide location/favor filters
            document.getElementById('caste-select-container').style.display = 'block';
            document.getElementById('favour-select-container').style.display = 'block';
            document.getElementById('location-favor-filters').style.display = 'none';
          } else {
            // Hide caste select and show location/favor filters
            document.getElementById('caste-select-container').style.display = 'none';
            document.getElementById('favour-select-container').style.display = 'none';
            document.getElementById('location-favor-filters').style.display = 'block';
          }
        }
      });

      // Handle the "Select All" checkbox click event
      const selectAllCheckbox = document.getElementById('select-all-checkbox');

      selectAllCheckbox.addEventListener('change', function () {
        const isChecked = selectAllCheckbox.checked;
        selectedVoters = []; // Reset selected voters array

        // Loop through each row and toggle its checkbox
        const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = isChecked; // Check/uncheck the checkbox
          const row = checkbox.closest('tr');
          row.classList.toggle('selected', isChecked); // Add/remove selected class

          const voterId = checkbox.value;
          if (isChecked) {
            // Add voter ID to selectedVoters if checkbox is checked
            selectedVoters.push(voterId);
          }
        });

        // Show or hide caste select based on the number of selected voters
        if (selectedVoters.length > 0) {
          // Show caste select and hide location/favor filters
          document.getElementById('caste-select-container').style.display = 'block';
          document.getElementById('favour-select-container').style.display = 'block';
          document.getElementById('location-favor-filters').style.display = 'none';
        } else {
          // Hide caste select and show location/favor filters
          document.getElementById('favour-select-container').style.display = 'none';
          document.getElementById('caste-select-container').style.display = 'none';
          document.getElementById('location-favor-filters').style.display = 'block';
        }
      });

      // Add event listener to the "Assign" button
      document.getElementById('fav-update-button').addEventListener('click', function () {
        const selectedfavourId = document.getElementById('favour-type-select').value;

        // Ensure that a favour and at least one voter are selected
        if (!selectedfavourId || selectedfavourId === "Select Favour Type") {
          alert('Please select a favour.');
          return;
        }

        if (selectedVoters.length === 0) {
          alert('Please select at least one voter.');
          return;
        }

        // Prepare the payload to send to the API
        const payload = {
          "voter_ids": selectedVoters.map(voterId => parseInt(voterId)), // Ensure voter IDs are integers
          "voter_favour_id": parseInt(selectedfavourId) // Ensure caste ID is an integer
        };
        // console.log('Payload:', JSON.stringify(payload));

        // Make the PUT request to assign caste to voters
        fetch('http://192.168.200.151:8001/api/favour/', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken() // CSRF token for security
          },
          body: JSON.stringify(payload)
        })
          .then(response => response.json())
          .then(data => {
            if (data.message) {
              alert(`Successfully updated ${data.message.split(' ')[2]} records.`);
              location.reload(); // Reload the page to refresh the table and reset selections

              // Initialize and Show Toasts
              const toastElList = [].slice.call(document.querySelectorAll('.toast'));
              const toastList = toastElList.map(function (toastEl) {
                return new bootstrap.Toast(toastEl);
              });
              toastList.forEach(toast => toast.show());
            } else {
              alert('Failed to assign caste. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error assigning caste:', error);
            alert('An error occurred while assigning the caste.');
          });
      });


      // Add event listener to the "Assign" button
      document.getElementById('update-button').addEventListener('click', function () {
        const selectedCasteId = document.getElementById('caste-select').value;

        // Ensure that a caste and at least one voter are selected
        if (!selectedCasteId || selectedCasteId === "Select Caste") {
          alert('Please select a caste.');
          return;
        }

        if (selectedVoters.length === 0) {
          alert('Please select at least one voter.');
          return;
        }

        // Prepare the payload to send to the API
        const payload = {
          "voter_ids": selectedVoters.map(voterId => parseInt(voterId)), // Ensure voter IDs are integers
          "voter_cast_id": parseInt(selectedCasteId) // Ensure caste ID is an integer
        };
        // console.log('Payload:', JSON.stringify(payload));

        // Make the PUT request to assign caste to voters
        fetch('http://192.168.200.151:8001/api/assign_voter_cast/', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken() // CSRF token for security
          },
          body: JSON.stringify(payload)
        })
          .then(response => response.json())
          .then(data => {
            if (data.message) {
              alert(`Successfully updated ${data.message.split(' ')[2]} records.`);
              location.reload(); // Reload the page to refresh the table and reset selections

              // Initialize and Show Toasts
              const toastElList = [].slice.call(document.querySelectorAll('.toast'));
              const toastList = toastElList.map(function (toastEl) {
                return new bootstrap.Toast(toastEl);
              });
              toastList.forEach(toast => toast.show());
            } else {
              alert('Failed to assign caste. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error assigning caste:', error);
            alert('An error occurred while assigning the caste.');
          });
      });

      // Helper function to get CSRF token from the page
      const getCsrfToken = () => {
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfTokenElement ? csrfTokenElement.value : ''; // Ensure CSRF token is returned if available
      };
    });

    // Select All checkbox logic
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    selectAllCheckbox.addEventListener('change', function () {
      const checkboxes = document.querySelectorAll('.form-check-input');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
      });
    });

    // Update Select All checkbox based on individual checkboxes
    const checkboxes = document.querySelectorAll('.form-check-input');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function () {
        if (![...checkboxes].some(cb => !cb.checked)) {
          selectAllCheckbox.checked = true;
        } else {
          selectAllCheckbox.checked = false;
        }
      });
    });
  </script>
</body>

</html>