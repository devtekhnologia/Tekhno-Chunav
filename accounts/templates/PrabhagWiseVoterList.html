<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Techno चुनाव-WardWiseVotersList</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />

    <style>
        /* scrollbar */
        body::-webkit-scrollbar {
            width: 10px;
        }

        body::-webkit-scrollbar-thumb:hover {
            background: #838ab6;
        }

        body::-webkit-scrollbar {
            background-color: transparent;
        }

        body::-webkit-scrollbar-thumb {
            background: #9DA5D5;
            border-radius: 8px;
        }

        table th {
            font-weight: 600;
            background-color: #DCE1FF !important;
        }

        .search {
            position: relative;
        }

        .btn-close {
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }

        .input-group {
            position: relative;
        }

        .custom-text-light {
            color: gray;
        }
    </style>
</head>

<body>
    {% include "navbar.html" %}
    <div id="contentWrapper">
        <div style="flex: 1">
            <div class="container mt-3">

                <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item custom-text-light"><a class="nav-link"
                                href="/dashboard/">Dashboard</a></li>
                        <li class="breadcrumb-item custom-text-light" aria-current="page" style="cursor: default;">Voter
                        </li>
                        <li class="breadcrumb-item" aria-current="page" style="cursor: default;">Ward Wise Voters
                            List</li>
                    </ol>
                </nav>

                <div class="row">
                    <div class="col-12">
                        <div class="overflow-hidden card bg-light rounded table-card mb-3">
                            <div class="row">
                                <div class="col mx-5">
                                    <br><br>
                                    <div class="mb-4">
                                        <select id="wardSelect" class="form-select" aria-label="Select Town">
                                            <option value="" disabled selected>Select Ward</option>
                                        </select>
                                    </div>
                                    <div class="row justify-content-center text-center">
                                        <div class="col-4">
                                            <h5 class="mt-1" style="cursor: default;"><strong>Total Voters:</strong>
                                                <span id="voterCount">0</span>
                                            </h5>
                                        </div>
                                        <div class="col-4">
                                            <h5 class="mt-1" style="cursor: default;"><strong>Voted Voters:</strong>
                                                <span id="votedCount">0</span>
                                            </h5>
                                            <p id="votedCountParcent"><i><b>Percent:</b></i></p>
                                        </div>
                                        <div class="col-4">
                                            <h5 class="mt-1" style="cursor: default;"><strong>Non-voted Voters:</strong>
                                                <span id="non-votedCount">0</span>
                                            </h5>
                                            <p id="non-votedCountParcent"><i><b>Percent:</b></i></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Search -->
                <div class="d-flex justify-content-end gap-3 me-4 mb-1">
                    <!-- Voter caste assign -->
                    <!-- <div class="mb-3" style="display: none;" id="caste-select-container">
                        <div class="input-group mb-3" style="width: 230px;">
                            <select id="caste-select" class="d-flex form-select bg-light"
                                aria-label="Small select example">
                                <option selected>Select Caste</option>
                            </select>
                            <button id="update-button" class="btn btn-primary input-group-append ">Assign</button>
                        </div>
                        <div class="mb-3" id="favour-select-container">
                            <div class="input-group mb-3" style="width: 270px;">
                                <select id="favour-type-select" class="form-select bg-light"
                                    aria-label="Small select example">
                                    <option selected>Select Favour Type</option>
                                    <option class="text-success" value="1">Green</option>
                                    <option class="text-danger" value="2">Red</option>
                                    <option class="text-warning" value="3">Yellow</option>
                                    <option class="text-primary" value="4">Blue</option>
                                    <option style="color: rgb(17, 180, 255);" value="5">Light Blue</option>
                                    <option style="color: palevioletred;" value="6">Pink</option>
                                    <option style="color: purple;" value="7">Purple</option>
                                </select>
                                <button id="fav-update-button" class="btn btn-primary input-group-append">Update</button>
                            </div>
                        </div>
                    </div> -->
                    <div class="mb-3" style="display: none;" id="caste-select-container">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="input-group mb-3" style="width: 100%;">
                                    <select id="caste-select" class="d-flex form-select bg-light"
                                        aria-label="Small select example">
                                        <option selected>Select Caste</option>
                                    </select>
                                    <button id="update-button"
                                        class="btn btn-primary input-group-append">Assign</button>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3" id="favour-select-container">
                                <div class="input-group mb-3" style="width: 100%;">
                                    <select id="favour-type-select" class="form-select bg-light"
                                        aria-label="Small select example">
                                        <option selected>Select Favour </option>
                                        <option class="text-success" value="1">Green</option>
                                        <option class="text-danger" value="2">Red</option>
                                        <option class="text-warning" value="3">Yellow</option>
                                        <option class="text-primary" value="4">Blue</option>
                                        <option style="color: rgb(17, 180, 255);" value="5">Light Blue</option>
                                        <option style="color: palevioletred;" value="6">Pink</option>
                                        <option style="color: purple;" value="7">Purple</option>
                                    </select>
                                    <button id="fav-update-button"
                                        class="btn btn-primary input-group-append">Assign</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-3 me-4 mb-3">
                        <div class="input-group" id="location-favor-filters">
                            <select id="town-type-select" class="form-select bg-light"
                                aria-label="Small select example">
                                <option selected>Select Favour Type</option>
                                <option class="text-success" value="1">Green</option>
                                <option class="text-danger" value="2">Red</option>
                                <option class="text-warning" value="3">Yellow</option>
                                <option class="text-primary" value="4">Blue</option>
                                <option style="color: rgb(17, 180, 255);" value="5">Light Blue</option>
                                <option style="color: palevioletred;" value="6">Pink</option>
                                <option style="color: purple;" value="7">Purple</option>
                            </select>
                            <!-- <button id="update-button" class="btn btn-primary input-group-append">Update</button> -->
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="search" style="width: 260px;">
                        <div class="input-group">
                            <input type="text" id="search-input" name="search" class="form-control bg-light"
                                placeholder="Search by Name" />
                            <button type="button" id="clear-button" class="btn-close" aria-label="Close"></button>
                            <button class="btn btn-success" type="button" id="search-button">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="col-12 mb-3 mb-lg-5">
                    <div class="overflow-hidden table-nowrap rounded table-card">
                        <div class="card">
                            <div class="table-responsive">
                                <table class="table mb-0 table-striped">
                                    <thead class="text-muted text-uppercase" style="display: none;" id="tableHeading">
                                        <tr>
                                            <th><input class="form-check-input" type="checkbox" value=""
                                                    id="select-all-checkbox"></th>
                                            <!-- Select All Checkbox -->
                                            <th class="text-center fw-bolder" style="width: 20%;">Sr. No.</th>
                                            <th class="fw-bolder" style="width: 35%;">Voter Name</th>
                                            <th class="fw-bolder" style="width: 30%;">Contact Number</th>
                                            <th class="fw-bolder" style="width: 15%;">Actions</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="votersTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="voterDetailsModal" tabindex="-1" aria-labelledby="voterDetailsModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-scrollable modal-lg">
                        <div class="modal-content">
                            <div class="modal-header thd">
                                <h5 class="modal-title" id="voterDetailsModalLabel">Voter Details</h5>
                                <div class="ms-auto">
                                    <a type="button" id="edit-button" class="btn btn-outline-danger me-2">
                                        <i class="fa-solid fa-user-pen"></i>&nbsp;Edit
                                    </a>
                                    <a type="button" id="family-button" class="btn btn-outline-primary">
                                        <i class="fa-solid fa-users"></i>&nbsp;Family</a>
                                </div>
                            </div>
                            <div class="modal-body">
                                <table class="table p-1">
                                    <tbody>
                                        <tr>
                                            <th class="bg-light fw-semibold">Voter Name</th>
                                            <td id="voter_name"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Parent Name</th>
                                            <td id="voter_parent_name"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Date of Birth</th>
                                            <td id="voter_dob"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Live Status</th>
                                            <td id="voter_live_status"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Gender</th>
                                            <td id="voter_gender"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Contact Number</th>
                                            <td id="voter_contact_number"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Age</th>
                                            <td id="voter_age"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Marital Status</th>
                                            <td id="marital_status"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Cast</th>
                                            <td id="voter_cast_name"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Location Type</th>
                                            <td id="voter_in_city"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Current Location</th>
                                            <td id="current_location"></td>
                                        </tr>

                                        <tr>
                                            <th class="bg-light fw-semibold">Town Name</th>
                                            <td id="town_name"></td>
                                        </tr>
                                        <tr>
                                            <th class="bg-light fw-semibold">Booth Name</th>
                                            <td id="booth_name"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-light m-1" id="export-pdf-button">
                                        <i class="fa-solid fa-arrow-up-from-bracket"></i>&nbsp;Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let currentVoterId = null;  // Variable to store the currently selected voter ID
            let votersData = [];         // Array to hold fetched voter data

            // Show loading animation until data is fetched
            // function onDropdownChange(event) {
            //     const dropdown = event.target;
            //     const selectedValue = wardSelect.value;

            //     // Only proceed if the selected value is not the default one
            //     if (selectedValue !== "0") {
            //         document.getElementById('loading').style.display = 'block';
            //         document.getElementById('result').textContent = ''; // Clear previous result

            //         fetchData(selectedValue).then((data) => {
            //             // Hide loading animation once data is fetched
            //             document.getElementById('loading').style.display = 'none';

            //             // Show the fetched data
            //             document.getElementById('result').textContent = data;
            //         });
            //     }

            // Function to fetch towns and set up the select dropdown
            function fetchPrabhags() {
                fetch('http://192.168.1.38:8000/api/get_prabhags/')
                    .then(response => response.json())
                    .then(data => {
                        const wardSelect = document.getElementById('wardSelect');
                        data.forEach(prabhag => {
                            const option = document.createElement('option');
                            option.value = prabhag.prabhag_id;
                            option.textContent = prabhag.prabhag_name;
                            wardSelect.appendChild(option);
                        });

                        // Add event listener for town selection
                        wardSelect.addEventListener('change', function () {
                            const selectedTownId = wardSelect.value;
                            if (selectedTownId) {
                                fetchVoters(selectedTownId); // Fetch voters based on selected town
                            }
                        });
                    })
                    .catch(error => console.error('Error fetching towns data:', error));
            }

            // Function to fetch voters based on town_id
            async function fetchVoters(prabhagId) {
                try {
                    const response = await fetch(`http://192.168.1.38:8000/api/get_voters_by_prabhagh/${prabhagId}/`);
                    const data = await response.json();
                    votersData = data;  // Store the fetched voters data
                    renderVoters(votersData);  // Render voters in the table
                }
                catch (error) {
                    // console.error('Error fetching voters data:', error);
                }
            }

            // Function to render voters in the table
            function renderVoters(voters) {
                const tableBody = document.getElementById('votersTableBody');
                tableBody.innerHTML = ''; // Clear previous voters

                // Hide the table headings if there are no voters
                if (voters.length === 0) {
                    tableHeading.style.display = 'none'; // Hide the heading
                } else {
                    // Show the table heading if there are voters
                    tableHeading.style.display = 'table-header-group'; // Ensure the heading is visible
                }

                const totalVoters = voters.length;  // Total number of voters
                const votedVoters = voters.filter(voter => voter.voter_vote_confirmation_id !== null).length; // Count of voted voters
                const nonVotedVoters = totalVoters - votedVoters; // Count of non-voted voters
                const votedVotersParc = ((votedVoters / totalVoters) * 100).toFixed(2);
                const nonVotedVotersParc = ((nonVotedVoters / totalVoters) * 100).toFixed(2);

                // Update counts in the respective elements
                document.getElementById('voterCount').textContent = totalVoters;
                document.getElementById('votedCount').textContent = votedVoters;
                document.getElementById('non-votedCount').textContent = nonVotedVoters;
                document.getElementById('votedCountParcent').textContent = votedVotersParc;
                document.getElementById('non-votedCountParcent').textContent = nonVotedVotersParc;
                document.getElementById('votedCountParcent').innerHTML = "<b>Percent:</b> <i>" + votedVotersParc + "%</i>";
                document.getElementById('votedCountParcent').style.fontStyle = "italic"; // Optional for the overall style

                document.getElementById('non-votedCountParcent').innerHTML = "<b>Percent:</b> <i>" + nonVotedVotersParc + "%</i>";
                document.getElementById('non-votedCountParcent').style.fontStyle = "italic"; // Optional for the overall style

                // Sort voters alphabetically by voter_name
                voters.sort((a, b) => a.voter_name.localeCompare(b.voter_name));

                // Populate the table with voters
                voters.forEach((voter, index) => {
                    const row = document.createElement('tr');

                    const checkboxCell = document.createElement('td');
                    checkboxCell.style.textAlign = 'center';
                    const checkbox = document.createElement('input');
                    checkbox.classList.add('form-check-input'); // Add Bootstrap class for the checkbox
                    checkbox.type = 'checkbox'; // Set the checkbox type
                    checkbox.id = `voterCheck_${voter.voter_id}`; // Set the checkbox ID to the voter ID
                    checkbox.value = voter.voter_id;
                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);

                    const srNoCell = document.createElement('td');
                    srNoCell.style.textAlign = 'center';
                    srNoCell.textContent = index + 1;
                    row.appendChild(srNoCell);

                    const nameCell = document.createElement('td');
                    nameCell.textContent = capitalizeWords(voter.voter_name);
                    row.appendChild(nameCell);

                    const contactCell = document.createElement('td');
                    contactCell.style.textAlign = 'start';
                    contactCell.textContent = voter.voter_contact_number || 'None';
                    row.appendChild(contactCell);

                    // Actions Cell
                    const actionsCell = document.createElement('td');
                    let detailsButton;
                    detailsButton = document.createElement('button');
                    detailsButton.className = 'btn voter-detail-link btn-light btn-sm m-1';
                    detailsButton.innerHTML = '<i class="fa-solid fa-circle-info"></i>';

                    // Create a toggle button for vote confirmation
                    const voteConfirmationButton = document.createElement('button');

                    // Set the button icon based on the current confirmation status
                    if (voter.voter_vote_confirmation_id === null) {
                        voteConfirmationButton.className = 'btn btn-secondary btn-sm m-1';
                        voteConfirmationButton.innerHTML = '<i class="fa-regular fa-thumbs-up"></i>'; // Icon for "Confirm Vote"
                    } else {
                        voteConfirmationButton.className = 'btn btn-primary btn-sm m-1';
                        voteConfirmationButton.innerHTML = '<i class="fa-solid fa-thumbs-up"></i>'; // Icon for "Undo Confirmation"
                    }




                    // Add event listener for toggling vote confirmation
                    voteConfirmationButton.addEventListener('click', async () => {
                        const newConfirmationStatus = voter.voter_vote_confirmation_id === null ? 1 : null; // Toggle logic

                        try {
                            const response = await fetch(`http://192.168.1.38:8000/api/voter_confirmation/${voter.voter_id}/`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ voter_vote_confirmation_id: newConfirmationStatus })
                            });

                            if (!response.ok) {
                                throw new Error('Failed to update vote confirmation status');
                            }

                            // Update the button icon and voter object
                            voter.voter_vote_confirmation_id = newConfirmationStatus; // Update the current status
                            // voteConfirmationButton.innerHTML = newConfirmationStatus === null
                            //     ? '<i class="fa-regular fa-thumbs-up"></i>' // Icon for "Confirm Vote"
                            //     : '<i class="fa-solid fa-thumbs-up"></i>'; // Icon for "Undo Confirmation"
                            // Set the button icon based on the current confirmation status
                            console.log('After status', newConfirmationStatus);

                            if (newConfirmationStatus === null) {
                                voteConfirmationButton.className = 'btn btn-secondary btn-sm m-1';
                                voteConfirmationButton.innerHTML = '<i class="fa-regular fa-thumbs-up"></i>'; // Icon for "Confirm Vote"
                            } else {
                                voteConfirmationButton.className = 'btn btn-primary btn-sm m-1';
                                voteConfirmationButton.innerHTML = '<i class="fa-solid fa-thumbs-up"></i>'; // Icon for "Undo Confirmation"
                            }

                        } catch (error) {
                            console.error('Error toggling vote confirmation:', error);
                            alert('Error toggling vote confirmation. Please try again.');
                        }
                    });
                    actionsCell.appendChild(voteConfirmationButton);

                    // Conditional button based on voter_vote_confirmation_id
                    // if (voter.voter_vote_confirmation_id === null) {
                    //     detailsButton = document.createElement('button');
                    //     detailsButton.className = 'btn voter-detail-link btn-secondary btn-sm';
                    //     detailsButton.innerHTML = '<i class="fa-regular fa-circle-xmark"></i>';
                    // } else if (voter.voter_vote_confirmation_id === 1) {
                    //     detailsButton = document.createElement('button');
                    //     detailsButton.className = 'btn voter-detail-link btn-primary btn-sm';
                    //     detailsButton.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
                    // } else {
                    //     // Optionally, handle other cases or leave empty
                    //     detailsButton = document.createElement('button');
                    //     detailsButton.className = 'btn btn-danger btn-sm';
                    //     detailsButton.textContent = 'No Action';
                    // }

                    detailsButton.onclick = function () {
                        currentVoterId = voter.voter_id;
                        // Fetch voter details from the API
                        fetch(`http://192.168.1.38:8000/api/voters/${voter.voter_id}/`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Network response was not ok');
                                }
                                return response.json();
                            })
                            .then(voterDetails => {
                                // Populate the modal with voter details
                                document.getElementById('voter_name').textContent = capitalizeWords(voterDetails.voter_name) || '--';
                                document.getElementById('voter_parent_name').textContent = capitalizeWords(voterDetails.voter_parent_name) || '--';
                                document.getElementById('voter_dob').textContent = voterDetails.voter_dob || '--';
                                document.getElementById('voter_gender').textContent = voterDetails.voter_gender || '--';
                                document.getElementById('voter_contact_number').textContent = voterDetails.voter_contact_number || '--';
                                document.getElementById('voter_age').textContent = voterDetails.voter_age || '--';
                                document.getElementById('voter_cast_name').textContent = voterDetails.voter_cast_name || '--';
                                document.getElementById('town_name').textContent = voterDetails.town_name || '--';
                                document.getElementById('booth_name').textContent = voterDetails.booth_name || '--';

                                document.getElementById('voter_in_city').textContent = (voterDetails.voter_in_city_id === 1) ? 'In City' : (voterDetails.voter_in_city_id === 2 ? 'Near City' : (voterDetails.voter_in_city_id === 3 ? 'Out of City' : '--'));
                                document.getElementById('voter_live_status').textContent = (voterDetails.voter_live_status_id === 1) ? 'Alive' : (voterDetails.voter_live_status_id === 2 ? 'Dead' : '--');
                                document.getElementById('marital_status').textContent = voterDetails.voter_marital_status_id || '--';
                                document.getElementById('current_location').textContent = voterDetails.voter_current_location || '--';

                                // Update the Family button with the voter ID
                                document.getElementById('family-button').href = `/familydetails/${voter.voter_id}`;

                                // Update the Edit button with the voter ID
                                document.getElementById('edit-button').href = `/editvoter/${voter.voter_id}/`;

                                // Change the background color of elements with class 'thd' based on voter_favour_id
                                const thdElements = document.querySelectorAll('.thd');
                                thdElements.forEach(element => {
                                    element.style.backgroundColor = ''; // Clear previous colors
                                });

                                // Set Voter Details background color based on favour_id
                                switch (parseInt(voterDetails.voter_favour_id)) {
                                    case 1:
                                        thdElements.forEach(element => {
                                            element.style.backgroundColor = '#D1E7DD'; // Light Green
                                        });
                                        break;
                                    case 2:
                                        thdElements.forEach(element => {
                                            element.style.backgroundColor = '#F8D7DA'; // Light Red
                                        });
                                        break;
                                    case 3:
                                        thdElements.forEach(element => {
                                            element.style.backgroundColor = '#fff3cd'; // Light Yellow
                                        });
                                        break;
                                    case 4:
                                        thdElements.forEach(element => {
                                            element.style.backgroundColor = '#DCE1FF'; // Light Blue
                                        });
                                        break;
                                    case 5:
                                        thdElements.forEach(element => {
                                            element.style.backgroundColor = '#d1faff'; // Light Sky Blue
                                        });
                                        break;
                                    case 6:
                                        thdElements.forEach(element => {
                                            element.style.backgroundColor = '#fed6ff'; // Light Pink
                                        });
                                        break;
                                    case 7:
                                        thdElements.forEach(element => {
                                            element.style.backgroundColor = '#ebd1ff'; // Light Purple
                                        });
                                        break;
                                    default:
                                        thdElements.forEach(element => {
                                            element.style.backgroundColor = '#D3D3D3'; // Default Light Grey
                                        });
                                }
                                // Show the modal
                                const voterDetailsModal = new bootstrap.Modal(document.getElementById('voterDetailsModal'));
                                voterDetailsModal.show();
                            })
                    };

                    actionsCell.appendChild(detailsButton);
                    row.appendChild(actionsCell);

                    // New column for voter_favour_id (optional display)
                    const favourCell = document.createElement('td');
                    switch (voter.favour_id) {
                        case 1:
                            favourCell.style.backgroundColor = 'Green'; // Green
                            break;
                        case 2:
                            favourCell.style.backgroundColor = 'Red'; // Red
                            break;
                        case 3:
                            favourCell.style.backgroundColor = 'Yellow'; // Yellow
                            break;
                        case 4:
                            favourCell.style.backgroundColor = '#0B5ED7'; // Blue
                            break;
                        case 5:
                            favourCell.style.backgroundColor = 'rgb(17, 180, 255)'; // Sky Blue
                            break;
                        case 6:
                            favourCell.style.backgroundColor = 'palevioletred'; // Pink
                            break;
                        case 7:
                            favourCell.style.backgroundColor = 'purple'; // Purple
                            break;
                        default:
                            favourCell.style.backgroundColor = '#D3D3D3'; // Default Grey
                    }
                    row.appendChild(favourCell);
                    tableBody.appendChild(row);
                });
            }

            // Add event listener for the export button in Voter Details
            document.getElementById('export-pdf-button').addEventListener('click', function () {
                if (currentVoterId) {
                    const pdfUrl = `http://192.168.1.38:8000/api/generate_voter_pdf/${currentVoterId}/`;
                    fetch(pdfUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.blob(); // Get the response as a Blob
                        })
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob); // Create a URL for the Blob
                            const a = document.createElement('a'); // Create a link element
                            a.href = url;
                            a.download = `voterDetails.pdf`; // Set the desired file name
                            document.body.appendChild(a); // Append the link to the body
                            a.click(); // Programmatically click the link to trigger the download
                            a.remove(); // Remove the link from the document
                            window.URL.revokeObjectURL(url); // Revoke the Object URL
                        })
                        .catch(error => console.error('Error generating PDF:', error));
                } else {
                    console.warn('No voter ID available for export.');
                }
            });

            // Favor type filter
            document.getElementById('town-type-select').addEventListener('change', function () {
                const selectedFavourId = parseInt(this.value);
                if (!isNaN(selectedFavourId)) {
                    const filteredVoters = votersData.filter(voter => voter.favour_id === selectedFavourId);
                    renderVoters(filteredVoters);
                } else {
                    renderVoters(votersData); // If no selection, show all voters
                }
            });

            // Function to capitalize the first letter of each word
            function capitalizeWords(str) {
                return str.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ');
            }

            // Function to get URL parameters
            function getTownIdFromPath() {
                const pathParts = window.location.pathname.split('/'); // Split the path by '/'
                const townId = pathParts[pathParts.length - 2]; // Get the second to last element (the town_id)
                return townId;
            }


            // Main function to initialize the page
            function init() {
                fetchPrabhags();  // Fetch towns data on page load

                // Get town_id from the URL path
                const townIdFromPath = getTownIdFromPath();
                // console.log('town_id from path:', townIdFromPath); // Log the retrieved town_id

                if (townIdFromPath) {
                    const townId = parseInt(townIdFromPath, 10);
                    //   console.log('Parsed townId:', townId); // Log the parsed integer
                    fetchVoters(townId); // Fetch voters for the town_id from URL
                } else {
                    //   console.log('No town_id found in URL path'); // Log if no town_id is found
                }
            }
            init();  // Initialize the page

            // Search functionality
            document.getElementById('search-input').addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase();
                const filteredVoters = votersData.filter(voter =>
                    voter.voter_name.toLowerCase().includes(searchTerm)
                );
                renderVoters(filteredVoters);
            });

            // Clear search input
            document.getElementById('clear-button').addEventListener('click', () => {
                document.getElementById('search-input').value = '';
                renderVoters(votersData); // Render original voters data
            });
        });


        // // Multi Caste assign function
        // document.addEventListener('DOMContentLoaded', function () {
        //     // Fetch caste data from the API and populate the caste select options
        //     fetch('http://192.168.1.38:8000/api/cast/')
        //         .then(response => response.json())
        //         .then(data => {
        //             const casteSelect = document.getElementById('caste-select');

        //             // Add each caste option to the select dropdown
        //             data.forEach(caste => {
        //                 const option = document.createElement('option');
        //                 option.value = caste.cast_id;
        //                 option.textContent = caste.cast_name;
        //                 casteSelect.appendChild(option);
        //             });
        //         })
        //         .catch(error => console.error('Error fetching caste data:', error));

        //     // Add event listener to handle voter row selection
        //     let selectedVoters = [];
        //     const tableBody = document.getElementById('votersTableBody');

        //     tableBody.addEventListener('click', function (event) {
        //         // Check if the clicked element is a checkbox
        //         if (event.target.type === 'checkbox') {
        //             const checkbox = event.target;
        //             const row = checkbox.closest('tr'); // Get the row that contains the checkbox
        //             const voterId = checkbox.value; // Get voter ID from the checkbox value

        //             // Toggle the "selected" class to indicate voter selection
        //             row.classList.toggle('selected', checkbox.checked);

        //             // Add or remove the voter from the selectedVoters array
        //             if (checkbox.checked) {
        //                 // Add voter ID to selectedVoters if checkbox is checked
        //                 selectedVoters.push(voterId);
        //             } else {
        //                 // Remove voter ID from selectedVoters if checkbox is unchecked
        //                 selectedVoters = selectedVoters.filter(id => id !== voterId);
        //             }

        //             // Show or hide caste select based on the number of selected voters
        //             if (selectedVoters.length > 0) {
        //                 // Show caste select and hide location/favor filters
        //                 document.getElementById('caste-select-container').style.display = 'block';
        //                 document.getElementById('location-favor-filters').style.display = 'none';
        //             } else {
        //                 // Hide caste select and show location/favor filters
        //                 document.getElementById('caste-select-container').style.display = 'none';
        //                 document.getElementById('location-favor-filters').style.display = 'block';
        //             }
        //         }
        //     });

        // // Add event listener to the "Assign" button
        // document.getElementById('update-button').addEventListener('click', function () {
        //     const selectedCasteId = document.getElementById('caste-select').value;

        //     // Ensure that a caste and at least one voter are selected
        //     if (!selectedCasteId || selectedCasteId === "Select Caste") {
        //         alert('Please select a caste.');
        //         return;
        //     }

        //     if (selectedVoters.length === 0) {
        //         alert('Please select at least one voter.');
        //         return;
        //     }

        //     // Prepare the payload to send to the API
        //     const payload = {
        //         "voter_ids": selectedVoters.map(voterId => parseInt(voterId)), // Ensure voter IDs are integers
        //         "voter_cast_id": parseInt(selectedCasteId) // Ensure caste ID is an integer
        //     };
        //     console.log('Payload:', JSON.stringify(payload));

        //     // Make the PUT request to assign caste to voters
        //     fetch('http://192.168.1.38:8000/api/assign_voter_cast/', {
        //         method: 'PUT',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             'X-CSRFToken': getCsrfToken() // CSRF token for security
        //         },
        //         body: JSON.stringify(payload)
        //     })
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.message) {
        //                 alert(`Successfully updated ${data.message.split(' ')[2]} records.`);
        //                 location.reload(); // Reload the page to refresh the table and reset selections

        //                 // Initialize and Show Toasts
        //                 const toastElList = [].slice.call(document.querySelectorAll('.toast'));
        //                 const toastList = toastElList.map(function (toastEl) {
        //                     return new bootstrap.Toast(toastEl);
        //                 });
        //                 toastList.forEach(toast => toast.show());
        //             } else {
        //                 alert('Failed to assign caste. Please try again.');
        //             }
        //         })
        //         .catch(error => {
        //             console.error('Error assigning caste:', error);
        //             alert('An error occurred while assigning the caste.');
        //         });
        // });

        // // Helper function to get CSRF token from the page
        // const getCsrfToken = () => {
        //     const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        //     return csrfTokenElement ? csrfTokenElement.value : ''; // Ensure CSRF token is returned if available
        // };

        document.addEventListener('DOMContentLoaded', function () {
            // Fetch caste data from the API and populate the caste select options
            fetch('http://192.168.1.38:8000/api/cast/')
                .then(response => response.json())
                .then(data => {
                    const casteSelect = document.getElementById('caste-select');

                    // Add each caste option to the select dropdown
                    data.forEach(caste => {
                        const option = document.createElement('option');
                        option.value = caste.cast_id;
                        option.textContent = caste.cast_name;
                        casteSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching caste data:', error));

            // Add event listener to handle voter row selection
            let selectedVoters = [];
            const tableBody = document.getElementById('votersTableBody');

            tableBody.addEventListener('click', function (event) {
                // Check if the clicked element is a checkbox
                if (event.target.type === 'checkbox') {
                    const checkbox = event.target;
                    const row = checkbox.closest('tr'); // Get the row that contains the checkbox
                    const voterId = checkbox.value; // Get voter ID from the checkbox value

                    // Toggle the "selected" class to indicate voter selection
                    row.classList.toggle('selected', checkbox.checked);

                    // Add or remove the voter from the selectedVoters array
                    if (checkbox.checked) {
                        // Add voter ID to selectedVoters if checkbox is checked
                        selectedVoters.push(voterId);
                    } else {
                        // Remove voter ID from selectedVoters if checkbox is unchecked
                        selectedVoters = selectedVoters.filter(id => id !== voterId);
                    }

                    // Show or hide caste select based on the number of selected voters
                    if (selectedVoters.length > 0) {
                        // Show caste select and hide location/favor filters
                        document.getElementById('caste-select-container').style.display = 'block';
                        document.getElementById('favour-select-container').style.display = 'block';
                        document.getElementById('location-favor-filters').style.display = 'none';
                    } else {
                        // Hide caste select and show location/favor filters
                        document.getElementById('caste-select-container').style.display = 'none';
                        document.getElementById('favour-select-container').style.display = 'none';
                        document.getElementById('location-favor-filters').style.display = 'block';
                    }
                }
            });

            // Handle the "Select All" checkbox click event
            const selectAllCheckbox = document.getElementById('select-all-checkbox');

            selectAllCheckbox.addEventListener('change', function () {
                const isChecked = selectAllCheckbox.checked;
                selectedVoters = []; // Reset selected voters array

                // Loop through each row and toggle its checkbox
                const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = isChecked; // Check/uncheck the checkbox
                    const row = checkbox.closest('tr');
                    row.classList.toggle('selected', isChecked); // Add/remove selected class

                    const voterId = checkbox.value;
                    if (isChecked) {
                        // Add voter ID to selectedVoters if checkbox is checked
                        selectedVoters.push(voterId);
                    }
                });

                // Show or hide caste select based on the number of selected voters
                if (selectedVoters.length > 0) {
                    // Show caste select and hide location/favor filters
                    document.getElementById('caste-select-container').style.display = 'block';
                    document.getElementById('favour-select-container').style.display = 'block';
                    document.getElementById('location-favor-filters').style.display = 'none';
                } else {
                    // Hide caste select and show location/favor filters
                    document.getElementById('favour-select-container').style.display = 'none';
                    document.getElementById('caste-select-container').style.display = 'none';
                    document.getElementById('location-favor-filters').style.display = 'block';
                }
            });

            // Add event listener to the "Assign" button
            document.getElementById('fav-update-button').addEventListener('click', function () {
                const selectedfavourId = document.getElementById('favour-type-select').value;

                // Ensure that a favour and at least one voter are selected
                if (!selectedfavourId || selectedfavourId === "Select Favour Type") {
                    alert('Please select a favour.');
                    return;
                }

                if (selectedVoters.length === 0) {
                    alert('Please select at least one voter.');
                    return;
                }

                // Prepare the payload to send to the API
                const payload = {
                    "voter_ids": selectedVoters.map(voterId => parseInt(voterId)), // Ensure voter IDs are integers
                    "voter_favour_id": parseInt(selectedfavourId) // Ensure caste ID is an integer
                };
                console.log('Payload:', JSON.stringify(payload));

                // Make the PUT request to assign caste to voters
                fetch('http://192.168.1.38:8000/api/favour/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken() // CSRF token for security
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert(`Successfully updated ${data.message.split(' ')[2]} records.`);
                            location.reload(); // Reload the page to refresh the table and reset selections

                            // Initialize and Show Toasts
                            const toastElList = [].slice.call(document.querySelectorAll('.toast'));
                            const toastList = toastElList.map(function (toastEl) {
                                return new bootstrap.Toast(toastEl);
                            });
                            toastList.forEach(toast => toast.show());
                        } else {
                            alert('Failed to assign caste. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error assigning caste:', error);
                        alert('An error occurred while assigning the caste.');
                    });
            });


            // Add event listener to the "Assign" button
            document.getElementById('update-button').addEventListener('click', function () {
                const selectedCasteId = document.getElementById('caste-select').value;

                // Ensure that a caste and at least one voter are selected
                if (!selectedCasteId || selectedCasteId === "Select Caste") {
                    alert('Please select a caste.');
                    return;
                }

                if (selectedVoters.length === 0) {
                    alert('Please select at least one voter.');
                    return;
                }

                // Prepare the payload to send to the API
                const payload = {
                    "voter_ids": selectedVoters.map(voterId => parseInt(voterId)), // Ensure voter IDs are integers
                    "voter_cast_id": parseInt(selectedCasteId) // Ensure caste ID is an integer
                };
                console.log('Payload:', JSON.stringify(payload));

                // Make the PUT request to assign caste to voters
                fetch('http://192.168.1.38:8000/api/assign_voter_cast/', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken() // CSRF token for security
                    },
                    body: JSON.stringify(payload)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            alert(`Successfully updated ${data.message.split(' ')[2]} records.`);
                            location.reload(); // Reload the page to refresh the table and reset selections

                            // Initialize and Show Toasts
                            const toastElList = [].slice.call(document.querySelectorAll('.toast'));
                            const toastList = toastElList.map(function (toastEl) {
                                return new bootstrap.Toast(toastEl);
                            });
                            toastList.forEach(toast => toast.show());
                        } else {
                            alert('Failed to assign caste. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error assigning caste:', error);
                        alert('An error occurred while assigning the caste.');
                    });
            });

            // Helper function to get CSRF token from the page
            const getCsrfToken = () => {
                const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
                return csrfTokenElement ? csrfTokenElement.value : ''; // Ensure CSRF token is returned if available
            };
        });

        // Select All checkbox logic
        const selectAllCheckbox = document.getElementById('select-all');
        selectAllCheckbox.addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('.form-check-input');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });

        // Update Select All checkbox based on individual checkboxes
        const checkboxes = document.querySelectorAll('.form-check-input');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                if (![...checkboxes].some(cb => !cb.checked)) {
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.checked = false;
                }
            });
        });
    </script>
</body>

</html>