<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Techno चुनाव-EditVoterDetails</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <style>
        /* scrollbar */
        body::-webkit-scrollbar {
            width: 10px;
        }

        body::-webkit-scrollbar-thumb:hover {
            background: #838ab6;
        }

        body::-webkit-scrollbar {
            background-color: transparent;
        }

        body::-webkit-scrollbar-thumb {
            background: #9DA5D5;
            border-radius: 8px;
        }

        .bg-blue {
            /* font-weight: 600; */
            background-color: #DCE1FF !important;
        }

        .bg-favour {
            background-color: #DCE1FF;
        }

        .bg-favour-green {
            background-color: #D1E7DD;
            /* Green */
        }

        .bg-favour-red {
            background-color: #F8D7DA;
            /* Red */
        }

        .bg-favour-yellow {
            background-color: #fff3cd;
            /* Yellow */
        }

        .search {
            position: relative;
        }

        .btn-close {
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            background-color: #F8F9FA;
        }

        .input-group {
            position: relative;
        }

        .pagination .page-item.active .page-link {
            color: #fff;
            background-color: #3C4CAC;
            border-color: #DCE1FF;
        }

        .custom-text-light {
            color: gray;
        }

        .p-left {
            padding-left: 20px;
        }

        .btn-add {
            background-color: #e54394;
            color: white;
        }

        .btn-add:hover {
            background-color: #3c4cac;
            color: white;
        }
    </style>
</head>

<body>

    {% include "navbar.html" %}
    <div id="contentWrapper">
        <div class="container mt-3">

            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item custom-text-light">
                        <a class="nav-link" href="/dashboard/">Dashboard</a>
                    </li>
                    <li class="breadcrumb-item" aria-current="page">Edit Voter Details</li>
                </ol>
            </nav>

            <!-- Voter Details Card -->
            <div class="card">
                <div class="card-body p-5 px-5">
                    <div
                        class="bg-favour {% if family_data.voter_favour_id == 1 %}bg-favour-green{% elif family_data.voter_favour_id == 2 %}bg-favour-red{% elif family_data.voter_favour_id == 3 %}bg-favour-yellow{% endif %} p-3 mb-4">
                        <h5 class="text-center mb-0">Edit Voter Details</h5>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="voter_name_input" class="form-label h6"><strong>Voter Name</strong></label>
                            <input type="text" name="voter_name_input" id="voter_name_input" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <label for="voter_parent_name_input" class="form-label h6"><strong>Voter Parent
                                    Name</strong></label>
                            <input type="text" name="voter_parent_name_input" id="voter_parent_name_input"
                                class="form-control" />
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="voter_dob_input" class="form-label h6"><strong>Date of Birth</strong></label>
                            <input type="date" name="voter_dob_input" id="voter_dob_input" class="form-control" />
                        </div>
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="headPersonContact" class="form-label h6"><strong>Gender</strong></label>
                                    <select class="form-select" name="voter_gender_input" id="voter_gender_input"
                                        aria-label="Default select example">
                                        <option value="null" selected>Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="voter_age_input" class="form-label h6"><strong>Age</strong></label>
                                    <input type="number" name="voter_age_input" id="voter_age_input"
                                        class="form-control" />
                                    <div id="age-error-message" class="text-danger mt-2" style="display: none;">Age must
                                        be at least 18.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="marital_status_input" class="form-label h6"><strong>Marital
                                    Status</strong></label>
                            <select class="form-select" name="marital_status_input" id="marital_status_input"
                                aria-label="Default select example">
                                <option value="null" selected>Select Marital Status</option>
                                <option value="1">Single</option>
                                <option value="2">Married</option>
                                <option value="3">Divorced</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="voter_contact_number_input"
                                class="form-label h6"><strong>Contact</strong></label>
                            <input type="number" name="voter_contact_number_input" id="voter_contact_number_input"
                                class="form-control" />
                            <div id="contact-error-message" class="text-danger mt-2">Contact number must be exactly 10
                                digits</div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="voter_favour_id_input" class="form-label h6">
                                <strong>Favour Color</strong>
                            </label>
                            <select class="form-select" name="voter_favour_id_input" id="voter_favour_id_input"
                                aria-label="Default select example">
                                <option value="0" selected>Select Color</option>
                                <option class="text-success" value="1">Favour</option>
                                <option class="text-danger" value="2">Against</option>
                                <option class="text-warning" value="3">Doubted</option>
                                <option style="color: rgb(17, 180, 255);" value="5">Pro</option>
                                <option class="text-primary" value="4">Pro Plus</option>
                                <option style="color: palevioletred;" value="6">No Vote</option>
                                <option style="color: purple;" value="7">No Vote Voted</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="vote_confirmation_input" class="form-label h6"><strong>Voted
                                    Status</strong></label>
                            <select class="form-select" name="vote_confirmation_input" id="vote_confirmation_input"
                                aria-label="Default select example">
                                <option selected>Yes / No</option>
                                <option value="1">Yes</option>
                                <option value="null">No</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="voter_in_city_input" class="form-label h6"><strong>location
                                    Type</strong></label>
                            <select class="form-select" name="voter_in_city_input" id="voter_in_city_input"
                                aria-label="Default select example" onchange="toggleLocationInput()">
                                <option selected>Select Gender</option>
                                <option value="1">In</option>
                                <option value="2">Near</option>
                                <option value="3">Out</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="current_location_input" class="form-label h6"><strong>Current
                                    Location</strong></label>
                            <input type="text" name="current_location_input" id="current_location_input"
                                class="form-control" disabled />
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="voter_live_status_input" class="form-label h6"><strong>Live
                                    Status</strong></label>
                            <select class="form-select" name="voter_live_status_input" id="voter_live_status_input"
                                aria-label="Default select example">
                                <option value="null" selected>Select live status</option>
                                <option value="1">Alive</option>
                                <option value="2">Dead</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="voter_cast_name_input" class="form-label h6"><strong>Caste</strong></label>
                            <select class="form-select" name="voter_cast_name_input" id="voter_cast_name_input">
                                <option value="null" selected>Select Caste</option>
                                <option value="1">Maratha</option>
                                <option value="2">Kunbi</option>
                                <option value="3">wani</option>
                                <option value="4">Chambhar</option>
                                <option value="5">Dhangar</option>
                                <option value="6">Mali</option>
                                <option value="7">Koli</option>
                                <option value="8">Ansari</option>
                                <option value="9">Pathan</option>
                                <option value="10">Quereshi</option>
                                <option value="11">Bohara</option>
                                <option value="12">Sheikh</option>
                                <option value="13">Catholic</option>
                                <option value="14">Protestantism</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="town_name_input" class="form-label h6"><strong>Town Name</strong></label>
                            <input type="text" name="town_name_input" id="town_name_input" class="form-control"
                                disabled />
                        </div>
                        <div class="col-md-6">
                            <label for="booth_name_input" class="form-label h6"><strong>Booth Name</strong></label>
                            <input type="text" name="booth_name_input" id="booth_name_input" class="form-control"
                                disabled />
                        </div>
                    </div>
                    <div class="row px-4 mb-4">
                        <div class="col text-center">
                            <!-- onclick="window.history.go(-1); return false;" -->
                            <button id="save-button" onclick="window.history.go(-1); return false;"
                                class="btn btn-primary col-3 mt-3">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toast Container -->
            <div id="toastContainer" aria-live="polite" aria-atomic="true" class="position-fixed bottom-0 end-0 p-3">
                <!-- Toasts will be appended here -->
            </div>

        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Fetch and populate voter details on page load
            window.onload = function () {
                const pathParts = window.location.pathname.split('/');
                const voterId = pathParts[pathParts.length - 2]; // Get the voter ID from the URL
                console.log('Voter ID:', voterId);

                fetch(`http://192.168.200.151:8001/api/voters/${voterId}/`)
                    .then(response => response.json())
                    .then(data => {
                        // Populate form fields with voter data
                        document.getElementById('voter_name_input').value = data.voter_name;
                        document.getElementById('voter_parent_name_input').value = data.voter_parent_name;
                        document.getElementById('voter_dob_input').value = data.voter_dob;
                        document.getElementById('voter_gender_input').value = data.voter_gender;
                        document.getElementById('voter_contact_number_input').value = data.voter_contact_number;
                        document.getElementById('voter_age_input').value = data.voter_age;
                        document.getElementById('voter_favour_id_input').value = data.voter_favour_id;
                        document.getElementById('vote_confirmation_input').value = data.voter_vote_confirmation_id;
                        // document.getElementById('voter_religion_name_input').value = data.voter_religion_name;
                        document.getElementById('voter_cast_name_input').value = data.voter_cast_id;
                        document.getElementById('town_name_input').value = data.town_name;
                        document.getElementById('booth_name_input').value = data.booth_name;
                        document.getElementById('marital_status_input').value = data.voter_marital_status_id;
                        document.getElementById('voter_in_city_input').value = data.voter_in_city_id;
                        document.getElementById('current_location_input').value = data.voter_current_location;
                        document.getElementById('voter_live_status_input').value = data.voter_live_status_id;
                    })
                    .catch(error => console.error('Error fetching voter data:', error));
                // Fetch and populate caste options
                // fetch('http://192.168.200.151:8001/api/cast')
                //     .then(response => response.json())
                //     .then(casteData => {
                //         const casteSelect = document.getElementById('voter_cast_name_input');
                //         casteData.forEach(caste => {
                //             const option = document.createElement('option');
                //             option.value = caste.cast_id;
                //             option.textContent = caste.cast_name;
                //             casteSelect.appendChild(option);
                //         });
                //     })
                //     .catch(error => console.error('Error fetching caste data:', error));
            };

            // Save the edited voter details
            document.getElementById('save-button').addEventListener('click', function () {
                console.log('clicked');
                
                const pathParts = window.location.pathname.split('/');
                const voterId = pathParts[pathParts.length - 2];

                const updatedData = {
                    voter_name: document.getElementById('voter_name_input').value || null,
                    voter_parent_name: document.getElementById('voter_parent_name_input').value || null,
                    voter_dob: document.getElementById('voter_dob_input').value || null,
                    voter_gender: document.getElementById('voter_gender_input').value || null,
                    voter_contact_number: document.getElementById('voter_contact_number_input').value || null,
                    voter_age: parseInt(document.getElementById('voter_age_input').value) || null,
                    voter_favour_id: parseInt(document.getElementById('voter_favour_id_input').value) || null,
                    voter_vote_confirmation_id: parseInt(document.getElementById('vote_confirmation_input').value) || null,
                    // voter_religion_name: document.getElementById('voter_religion_name_input').value || null,
                    voter_cast_id: parseInt(document.getElementById('voter_cast_name_input').value) || null,
                    town_name: document.getElementById('town_name_input').value || null,
                    booth_name: document.getElementById('booth_name_input').value || null,

                    voter_marital_status_id: parseInt(document.getElementById('marital_status_input').value) || null,
                    voter_in_city_id: parseInt(document.getElementById('voter_in_city_input').value) || null,
                    voter_current_location: document.getElementById('current_location_input').value || null,
                    voter_live_status_id: parseInt(document.getElementById('voter_live_status_input').value) || null
                };
                console.log('payload-', updatedData);
                // console.log('json-', JSON.stringify(updatedData));

                fetch(`http://192.168.200.151:8001/api/voters/${voterId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedData),
                })
                    .then(response => {
                        if (response === null) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json(); // Return the response as JSON
                    })
                    .then(data => {
                        // Display a success toast with updated voter information
                        showToast(`Voter updated successfully!`, true);

                        // Redirect to the previous page and refresh after a short delay
                        // setTimeout(() => {
                        //     window.history.back(); // Go back to the previous page
                        //     location.reload(); // Refresh the page
                        // }, 2000); // Delay before redirecting
                    })
                    .catch(error => {
                        // console.error('Error updating voter details:', error);
                        showToast("An error occurred while updating voter details.", false);
                    });
            });

            function toggleLocationInput() {
                const locationType = document.getElementById("voter_in_city_input").value;
                const locationInput = document.getElementById("current_location_input");

                // Enable location input only if "Near" or "Out" is selected
                if (locationType === "2" || locationType === "3") {
                    locationInput.disabled = false;
                } else {
                    locationInput.disabled = true;
                }
            }

            // Show toast notifications
            function showToast(message, isSuccess) {
                const toastType = isSuccess ? 'text-bg-success' : 'text-bg-danger';
                const toastHTML = `
                    <div class="toast align-items-center ${toastType} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;

                // Append the toast to the container
                const toastContainer = document.getElementById('toastContainer');
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);

                // Get the latest toast and show it
                const toastElement = toastContainer.lastChild;
                const toast = new bootstrap.Toast(toastElement);
                toast.show();

                // Remove the toast after a short delay
                setTimeout(() => {
                    toastElement.remove();
                }, 1500);
            }


            document.addEventListener('DOMContentLoaded', function () {
                const ageInput = document.getElementById('voter_age_input');
                const saveButton = document.getElementById('save-button');
                const ageErrorMessage = document.getElementById('age-error-message'); // Make sure this element exists

                // Function to validate age
                function validateAge() {
                    const age = ageInput.value;
                    if (age === '') {
                        // Don't check validation if the field is empty
                        ageErrorMessage.style.display = 'none';
                        saveButton.disabled = false;
                        return;
                    }

                    if (parseInt(age) < 18) {
                        // If age is less than 18, show error and disable save button
                        ageErrorMessage.style.display = 'block';
                        saveButton.disabled = true;
                    } else {
                        // If age is 18 or more, hide error and enable save button
                        ageErrorMessage.style.display = 'none';
                        saveButton.disabled = false;
                    }
                }

                // Event listener for changes in the age input field
                ageInput.addEventListener('input', validateAge);

                // Initial validation on page load (in case there's a value in the input)
                validateAge();
            });

            // Contact number validation
            document.addEventListener('DOMContentLoaded', function () {
                const contactNumberInput = document.getElementById('voter_contact_number_input');
                const saveButton = document.getElementById('save-button');
                const contactErrorMessage = document.getElementById('contact-error-message'); // Make sure this element exists

                // Function to validate contact number
                function validateContactNumber() {
                    const contactNumber = contactNumberInput.value;

                    // Check if the contact number has exactly 10 digits
                    if (contactNumber === '') {
                        // Don't check validation if the field is empty
                        contactErrorMessage.style.display = 'none';
                        saveButton.disabled = false;
                        return;
                    }

                    // Check if the input is a valid number and has exactly 10 digits
                    const isValidContactNumber = /^[0-9]{10}$/.test(contactNumber);

                    if (isValidContactNumber) {
                        // If valid, hide error and enable save button
                        contactErrorMessage.style.display = 'none';
                        saveButton.disabled = false;
                    } else {
                        // If invalid, show error and disable save button
                        contactErrorMessage.style.display = 'block';
                        saveButton.disabled = true;
                    }
                }

                // Event listener for changes in the contact number input field
                contactNumberInput.addEventListener('input', validateContactNumber);

                // Initial validation on page load (in case there's a value in the input)
                validateContactNumber();
            });


        </script>
</body>

</html>